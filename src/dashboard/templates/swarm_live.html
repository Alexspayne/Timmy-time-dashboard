{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ðŸ”´ Live Swarm Dashboard</h2>
        <div>
            <span class="badge badge-success" id="connection-status">Connecting...</span>
        </div>
    </div>
    
    <div class="grid grid-3" style="margin-bottom: 20px;">
        <div class="stat">
            <div class="stat-value" id="stat-agents">-</div>
            <div class="stat-label">Total Agents</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="stat-active">-</div>
            <div class="stat-label">Active</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="stat-tasks">-</div>
            <div class="stat-label">Active Tasks</div>
        </div>
    </div>
    
    <div class="grid grid-2">
        <div>
            <h3 style="margin-bottom: 12px;">Agents</h3>
            <div id="agents-list">
                <p style="color: var(--text-muted);">Loading agents...</p>
            </div>
        </div>
        <div>
            <h3 style="margin-bottom: 12px;">Active Auctions</h3>
            <div id="auctions-list">
                <p style="color: var(--text-muted);">Loading auctions...</p>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <h3 style="margin-bottom: 12px;">Swarm Log</h3>
        <div id="swarm-log" style="height: 200px; overflow-y: auto; background: var(--bg-tertiary); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 0.875rem;">
            <div style="color: var(--text-muted);">Waiting for updates...</div>
        </div>
    </div>
</div>

<script>
let ws = null;
let reconnectInterval = 1000;
const maxReconnectInterval = 30000;

function connect() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${window.location.host}/swarm/ws`);
    
    ws.onopen = function() {
        console.log('WebSocket connected');
        document.getElementById('connection-status').textContent = 'Live';
        document.getElementById('connection-status').className = 'badge badge-success';
        reconnectInterval = 1000;
        addLog('Connected to swarm', 'success');
    };
    
    ws.onmessage = function(event) {
        const message = JSON.parse(event.data);
        handleMessage(message);
    };
    
    ws.onclose = function() {
        console.log('WebSocket disconnected');
        document.getElementById('connection-status').textContent = 'Reconnecting...';
        document.getElementById('connection-status').className = 'badge badge-warning';
        addLog('Disconnected, reconnecting...', 'warning');
        
        setTimeout(connect, reconnectInterval);
        reconnectInterval = Math.min(reconnectInterval * 2, maxReconnectInterval);
    };
    
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
        addLog('Connection error', 'error');
    };
}

function handleMessage(message) {
    if (message.type === 'initial_state' || message.type === 'state_update') {
        const data = message.data;
        
        // Update stats
        document.getElementById('stat-agents').textContent = data.agents.total;
        document.getElementById('stat-active').textContent = data.agents.active;
        document.getElementById('stat-tasks').textContent = data.tasks.active;
        
        // Update agents list
        updateAgentsList(data.agents.list);
        
        // Update auctions list
        updateAuctionsList(data.auctions.list);
    }
}

function updateAgentsList(agents) {
    const container = document.getElementById('agents-list');
    
    if (!agents || agents.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted);">No agents registered</p>';
        return;
    }
    
    container.innerHTML = agents.map(agent => `
        <div class="agent-card">
            <div class="agent-avatar">${agent.name.charAt(0).toUpperCase()}</div>
            <div class="agent-info">
                <div class="agent-name">${agent.name}</div>
                <div class="agent-meta">${agent.description || 'No description'}</div>
                <div class="agent-meta">
                    <span class="badge badge-${agent.status === 'active' ? 'success' : agent.status === 'busy' ? 'warning' : 'danger'}">${agent.status}</span>
                    ${agent.min_bid} sats min bid
                    | ${agent.tasks_completed} tasks
                    | ${agent.total_earned} sats earned
                </div>
            </div>
        </div>
    `).join('');
}

function updateAuctionsList(auctions) {
    const container = document.getElementById('auctions-list');
    
    if (!auctions || auctions.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted);">No active auctions</p>';
        return;
    }
    
    container.innerHTML = auctions.map(auction => `
        <div class="agent-card">
            <div class="agent-info">
                <div class="agent-name">Task ${auction.task_id.slice(0, 8)}</div>
                <div class="agent-meta">
                    ${Math.round(auction.time_remaining)}s remaining
                    | ${auction.bid_count} bids
                </div>
            </div>
        </div>
    `).join('');
}

function addLog(message, type = 'info') {
    const log = document.getElementById('swarm-log');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'error' ? 'var(--danger)' : type === 'warning' ? 'var(--warning)' : type === 'success' ? 'var(--success)' : 'var(--text-secondary)';
    
    const entry = document.createElement('div');
    entry.style.marginBottom = '4px';
    entry.innerHTML = `<span style="color: var(--text-muted);">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
    
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

// Connect on load
connect();
</script>
{% endblock %}
